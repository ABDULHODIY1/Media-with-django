{% extends 'base.html' %}
{% load static %}

{% block content %}
<div id="Blog_container">
  {% for post in posts %}
  <div class="blog_card">
    <p id="auth">@{{ post.author.username }}</p>

    {% if post.image %}
    <img src="{{ post.image.url }}" width="100%" height="250">
    {% elif post.video %}
    <video width="100%" height="250" controls muted>
      <source src="{{ post.video.url }}" type="video/mp4">
    </video>
    {% endif %}
    <p class="Info">{{ post.text }}</p>
    <div class="saved">
      <p id="like-count-{{ post.id }}">{{ post.like_users.count }}</p>
      <p id="save-count-{{ post.id }}">{{ post.saves.count }}</p>
      <button class="like-btn" data-post-id="{{ post.id }}">
        <svg aria-label="Like" fill="currentColor" height="24" role="img" viewBox="0 0 24 24" width="24">
          <path d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0
                     3.072-2.652 4.959-5.197 7.222-2.512 2.243-3.865
                     3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141
                     14.072 2.5 12.167 2.5 9.122a4.989 4.989
                     0 0 1 4.708-5.218 4.21 4.21 0 0 1
                     3.675 1.941c.84 1.175.98 1.763
                     1.12 1.763s.278-.588
                     1.11-1.766a4.17 4.17
                     0 0 1 3.679-1.938" />
        </svg>
      </button>
      <button class="save-btn" data-post-id="{{ post.id }}">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 36 36">
          <g>
            <path d="M33,10H27a1,1,0,0,0-1,1v2a1,1,0,0,0,1,1h3V30H6V14H9a1,1,
                        0,0,0,1-1V11a1,1,0,0,0-1-1H3a1,1,0,0,0-1,1V33a1,1,
                        0,0,0,1,1H33a1,1,0,0,0,1-1V11A1,1,0,0,0,33,10Z" />
            <path d="M10.2,17.33l7.45,7.53a.5.5,0,0,0,.7,0l7.45-7.53a.79.79,
                        0,0,0,.2-.53.8.8,0,0,0-.8-.8H20V3a1,1,0,0,0-1-1H17a1,1,
                        0,0,0-1,1V16H10.8a.8.8,0,0,0-.8.8A.79.79,0,0,0,10.2,17.33Z" />
          </g>
        </svg>
      </button>
    </div>
  </div>
  {% empty %}
  <p>Hech qanday post yoâ€˜q.</p>
  {% endfor %}
</div>

<script>
  function getCSRFToken() {
    const name = 'csrftoken';
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      const [key, value] = cookie.trim().split('=');
      if (key === name) return decodeURIComponent(value);
    }
    return '';
  }




  const csrftoken = getCSRFToken();
  document.querySelectorAll('.like-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const postId = btn.dataset.postId;
      const res = await fetch(`/like-toggle/${postId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      });
      const data = await res.json();
      if (data.success) {
        document.getElementById(`like-count-${postId}`).textContent = data.total_likes;
        btn.innerHTML = data.is_liked ? `<svg fill="red" height="24" viewBox="0 0 24 24" width="24"><path d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0
                     3.072-2.652 4.959-5.197 7.222-2.512 2.243-3.865
                     3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141
                     14.072 2.5 12.167 2.5 9.122a4.989 4.989
                     0 0 1 4.708-5.218 4.21 4.21 0 0 1
                     3.675 1.941c.84 1.175.98 1.763
                     1.12 1.763s.278-.588
                     1.11-1.766a4.17 4.17
                     0 0 1 3.679-1.938"/></svg>`
          : `<svg fill="currentColor" height="24" viewBox="0 0 24 24" width="24"><path d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0
                     3.072-2.652 4.959-5.197 7.222-2.512 2.243-3.865
                     3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141
                     14.072 2.5 12.167 2.5 9.122a4.989 4.989
                     0 0 1 4.708-5.218 4.21 4.21 0 0 1
                     3.675 1.941c.84 1.175.98 1.763
                     1.12 1.763s.278-.588
                     1.11-1.766a4.17 4.17
                     0 0 1 3.679-1.938"/></svg>`;
      }
    });
  });




  document.querySelectorAll('.save-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const postId = btn.dataset.postId;
      const res = await fetch(`/save-toggle/${postId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      });
      const data = await res.json();
      if (data.success) {
        document.getElementById(`save-count-${postId}`).textContent = data.total_saves;
        btn.innerHTML = data.is_saved ? `<svg fill="green" width="28" height="28" viewBox="0 0 36 36"><g><path d="M33,10H27a1,1,0,0,0-1,1v2a1,1,0,0,0,1,1h3V30H6V14H9a1,1,0,0,0,1-1V11a1,1,0,0,0-1-1H3a1,1,0,0,0-1,1V33a1,1,0,0,0,1,1H33a1,1,0,0,0,1-1V11A1,1,0,0,0,33,10Z"/><path d="M10.2,17.33l7.45,7.53a.5.5,0,0,0,.7,0l7.45-7.53a.79.79,0,0,0,.2-.53.8.8,0,0,0-.8-.8H20V3a1,1,0,0,0-1-1H17a1,1,0,0,0-1,1V16H10.8a.8.8,0,0,0-.8.8A.79.79,0,0,0,10.2,17.33Z"/></g></svg>`
          : `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 36 36"><g><path d="M33,10H27a1,1,0,0,0-1,1v2a1,1,0,0,0,1,1h3V30H6V14H9a1,1,0,0,0,1-1V11a1,1,0,0,0-1-1H3a1,1,0,0,0-1,1V33a1,1,0,0,0,1,1H33a1,1,0,0,0,1-1V11A1,1,0,0,0,33,10Z"/><path d="M10.2,17.33l7.45,7.53a.5.5,0,0,0,.7,0l7.45-7.53a.79.79,0,0,0,.2-.53.8.8,0,0,0-.8-.8H20V3a1,1,0,0,0-1-1H17a1,1,0,0,0-1,1V16H10.8a.8.8,0,0,0-.8.8A.79.79,0,0,0,10.2,17.33Z"/></g></svg>`;
      }
    });
  });

</script>
{% endblock %}