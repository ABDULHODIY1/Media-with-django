{% extends "base.html" %}
{% load static %}
{% block content %}
<style>
  :root {
    --bg: #070707;
    --card: #0f0f0f;
    --muted: #bdbdbd;
    --accent: #00d25b;
    --muted-2: #8f8f8f;
    --glass: rgba(255, 255, 255, 0.02);
  }

  body {
    background: var(--bg);
    color: var(--muted);
  }

  .search-wrap {
    padding: 72px auto 40px;
    width: 60%;
  }

  .search-row {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: center;
  }

  #search-input {
    width: 100%;
    flex: 1;
    height: 52px;
    padding: 12px 16px;
    padding-left: 30px;
    border: 1px solid rgba(255, 255, 255, 0.04);
    background: linear-gradient(180deg, #0a0a0a, #070707);
    color: var(--muted);
    font-size: 15px;
    outline: none;
    box-shadow: 0 8px 28px rgba(0, 0, 0, 0.6);
  }

  #search-input::placeholder {
    color: var(--muted-3);
  }

  .icon-btn {
    height: 44px;
    padding: 8px 12px;
    border-radius: 12px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.04);
    cursor: pointer;
    color: var(--muted);
  }

  .icon-btn:active {
    transform: translateY(1px);
  }

  .results {
    margin-top: 130px;
    display: grid;
    grid-template-columns: 1fr;
    gap: 18px;
    justify-content: center;
  }

  @media(max-width:980px) {
    .results {
      grid-template-columns: 1fr;
    }
  }

  .gallery {
    background: var(--card);
    border-radius: 12px;
    padding: 14px;
    border: 1px solid var(--glass);
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 14px;
  }

  .card {
    background: #0b0b0b;
    border-radius: 12px;
    overflow: hidden;
    transition: transform .18s ease, box-shadow .18s;
    border: 1px solid rgba(255, 255, 255, 0.02);
  }

  .card:hover {
    transform: translateY(-6px);
    box-shadow: 0 18px 50px rgba(0, 0, 0, 0.7);
  }

  .media {
    width: 100%;
    height: 170px;
    object-fit: cover;
    display: block;
    background: #000;
  }

  .card-body {
    padding: 12px 14px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .caption {
    font-size: 13px;
    color: var(--muted-2);
    max-height: 3.6em;
    overflow: hidden;
    line-height: 1.2em;
  }

  .meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--muted);
  }

  .meta .left {
    color: var(--muted-2);
    font-weight: 600;
  }

  .meta .right {
    font-weight: 700;
    color: var(--muted);
  }

  .users {
    background: var(--card);
    border-radius: 12px;
    padding: 12px;
    border: 1px solid var(--glass);
    height: fit-content;
  }

  .user-row {
    display: flex;
    gap: 12px;
    align-items: center;
    padding: 8px;
    border-radius: 10px;
    cursor: pointer;
    transition: background .12s;
  }

  .user-row:hover {
    background: rgba(255, 255, 255, 0.02);
  }

  .avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    flex: 0 0 48px;
    border: 2px solid rgba(255, 255, 255, 0.03);
  }

  .user-info {
    font-size: 14px;
    color: var(--muted);
  }

  .username {
    color: white;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .user-meta {
    font-size: 12px;
    color: var(--muted-2);
    margin-top: 4px;
  }

  .hint {
    padding: 28px;
    text-align: center;
    color: var(--muted-2);
  }

  .badge-verified {
    color: #61b6ff;
    font-size: 12px;
    margin-left: 6px;
  }

  .follow-btn {
    margin-left: auto;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.04);
    padding: 6px 10px;
    border-radius: 8px;
    cursor: pointer;
    color: var(--muted);
  }

  .highlight {
    background: linear-gradient(90deg, rgba(0, 210, 91, 0.18), rgba(0, 210, 91, 0.06));
    border-radius: 4px;
    padding: 0 2px;
  }

  @media(max-width:560px) {
    .username {
      font-size: 13px;
    }

    .meta {
      font-size: 12px;
    }
  }
</style>

<div class="search-wrap" role="region" aria-label="Search">
  <div class="search-row">
    <input id="search-input" type="search" style="min-width:100%; left:60px;"
      placeholder="Search posts, users or captions — type anything..." autocomplete="off" aria-label="Search" />
    <button id="voice-btn" class="icon-btn" title="Voice search" aria-label="Voice search">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3z" stroke="currentColor" stroke-width="1.4"
          stroke-linecap="round" stroke-linejoin="round" />
        <path d="M19 11v1a7 7 0 0 1-14 0v-1" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"
          stroke-linejoin="round" />
        <path d="M12 19v4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
    </button>
    <button id="clear-btn" class="icon-btn" title="Clear">Clear</button>
  </div>

  <div class="results" aria-live="polite">
    <div class="gallery" id="gallery">
      <div class="hint">Qidiruv natijalari shu yerda paydo bo‘ladi — yozishni boshlang ✨</div>
    </div>
    <aside class="users" id="users">
      <div class="hint">Foydalanuvchilar</div>
    </aside>
  </div>
</div>

<script>
  const DEFAULT_AVATAR = "{% static 'image/default_user_image.png' %}";
  const SEARCH_URL = "{% url 'app:search_ajax' %}";
  const input = document.getElementById('search-input');
  const gallery = document.getElementById('gallery');
  const usersBox = document.getElementById('users');
  const clearBtn = document.getElementById('clear-btn');
  const voiceBtn = document.getElementById('voice-btn');
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const CSRF = getCookie('csrftoken');
  function esc(s) { if (s === null || s === undefined) return ''; return String(s).replace(/[&<>"'`=\/]/g, ch => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '/': '&#x2F;', '=': '&#x3D;', '`': '&#x60;' }[ch])); }
  function highlightText(text, q) {
    if (!q) return esc(text || '');
    const toks = String(q).trim().split(/\s+/).filter(Boolean).map(t => t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
    if (!toks.length) return esc(text || '');
    const re = new RegExp('(' + toks.join('|') + ')', 'ig');
    return esc(text || '').replace(re, '<span class="highlight">$1</span>');
  }
  function truncateHtml(htmlStr, maxChars = 140) {
    const tmp = document.createElement('div'); tmp.innerHTML = htmlStr || ''; const plain = tmp.textContent || tmp.innerText || '';
    if (plain.length <= maxChars) return esc(plain);
    return esc(plain.slice(0, maxChars).trim()) + '…';
  }

  function makePostCard(p, q) {
    const el = document.createElement('div'); el.className = 'card';
    if (p.image) {
      const img = document.createElement('img'); img.className = 'media'; img.src = p.image; img.alt = esc(p.caption || 'post image'); el.appendChild(img);
    } else if (p.video) {
      const v = document.createElement('video'); v.className = 'media'; v.controls = true; v.controlsList = "nodownload"; v.oncontextmenu = () => false;
      const src = document.createElement('source'); src.src = p.video; src.type = 'video/mp4'; v.appendChild(src); el.appendChild(v);
    } else {
      const ph = document.createElement('div'); ph.style.height = '170px'; ph.style.background = '#070707'; el.appendChild(ph);
    }

    const body = document.createElement('div'); body.className = 'card-body';
    const cap = document.createElement('div'); cap.className = 'caption';
    cap.innerHTML = truncateHtml(highlightText(p.caption || '', q), 160);
    body.appendChild(cap);

    const meta = document.createElement('div'); meta.className = 'meta';
    const left = document.createElement('div'); left.className = 'left'; left.innerHTML = `@${esc(p.author || 'unknown')}`;
    const right = document.createElement('div'); right.className = 'right';
    const likes = Number(p.likes || 0), comments = Number(p.comment_count || 0), views = Number(p.views || 0);
    right.innerHTML = `${likes} ❤️ • ${comments} 💬 • ${views} 👁`;
    meta.appendChild(left); meta.appendChild(right);
    body.appendChild(meta);

    el.appendChild(body);
    el.addEventListener('click', () => { if (p.url) window.location = p.url; });
    return el;
  }
  function makeUserRow(u, q) {
    const r = document.createElement('div'); r.className = 'user-row';
    const avatarUrl = u.avatar || DEFAULT_AVATAR;

    r.innerHTML = `
      <div class="avatar" style="background-image:url('${esc(avatarUrl)}')"></div>
      <div style="flex:1;">
        <div class="username">@${esc(u.username || 'user')} ${u.is_verified ? '<span class="badge-verified">✔</span>' : ''}</div>
        <div class="user-meta"><span class="full-name">${esc(u.full_name || '')}</span> • <span class="followers-count">${esc(String(u.followers || 0))}</span> followers</div>
      </div>
    `;

    let actionBtn;
    if (u.is_self) {
      actionBtn = document.createElement('button');
      actionBtn.className = 'follow-btn';
      actionBtn.textContent = 'View';
      actionBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (u.profile_url) window.location = u.profile_url;
      });
    } else {
      actionBtn = document.createElement('button');
      actionBtn.className = 'follow-btn';
      actionBtn.textContent = u.is_following ? 'Subscribing' : 'Subscribe';
      actionBtn.dataset.loading = '0';
      actionBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (actionBtn.dataset.loading === '1') return;
        actionBtn.dataset.loading = '1';
        const prevText = actionBtn.textContent;
        actionBtn.textContent = '...';
        const url = `/follow-toggle/${encodeURIComponent(u.username)}/`;

        try {
          const res = await fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
              'X-CSRFToken': CSRF,
              'Accept': 'application/json'
            }
          });
          if (res.redirected) {
            window.location = res.url;
            return;
          }
          if (!res.ok) throw new Error('Network error');
          const data = await res.json().catch(() => null);
          if (data && typeof data.is_following !== 'undefined') {
            u.is_following = Boolean(data.is_following);
            actionBtn.textContent = u.is_following ? 'Following' : 'Follow';
          } else {
            u.is_following = !u.is_following;
            actionBtn.textContent = u.is_following ? 'Following' : 'Follow';
          }
          const countSpan = r.querySelector('.followers-count');
          if (countSpan) {
            if (data && typeof data.followers_count !== 'undefined') {
              countSpan.textContent = String(data.followers_count);
            } else {
              let num = parseInt(countSpan.textContent || '0', 10);
              num = u.is_following ? (num + 1) : Math.max(0, num - 1);
              countSpan.textContent = String(num);
            }
          }
        } catch (err) {
          console.error('Follow error', err);
          alert('Xatolik yuz berdi — follow amalga oshmadi.');
          actionBtn.textContent = prevText;
        } finally {
          actionBtn.dataset.loading = '0';
        }
      });
    }
    r.appendChild(actionBtn);
    r.addEventListener('click', () => { if (u.profile_url) window.location = u.profile_url; });
    return r;
  }
  async function doSearch(q) {
    q = String(q || '').trim();
    if (!q) {
      gallery.innerHTML = '<div class="hint">Qidiruv natijalari shu yerda paydo bo‘ladi — yozishni boshlang ✨</div>';
      usersBox.innerHTML = '<div class="hint">Foydalanuvchilar</div>';
      return;
    }
    gallery.innerHTML = '<div class="hint">Qidirilmoqda...</div>';
    usersBox.innerHTML = '<div class="hint">Qidirilmoqda...</div>';

    try {
      const url = SEARCH_URL + '?q=' + encodeURIComponent(q);
      const resp = await fetch(url, { credentials: 'same-origin' });
      if (resp.redirected) { window.location = resp.url; return; }
      if (!resp.ok) throw new Error('Network error');

      const data = await resp.json();
      gallery.innerHTML = '';
      if (Array.isArray(data.posts) && data.posts.length) {
        const grid = document.createElement('div'); grid.className = 'grid';
        data.posts.forEach(p => grid.appendChild(makePostCard(p, q)));
        gallery.appendChild(grid);
      } else {
        gallery.innerHTML = '<div class="hint">Postlar topilmadi.</div>';
      }



      usersBox.innerHTML = '';
      if (Array.isArray(data.users) && data.users.length) {
        data.users.forEach(u => usersBox.appendChild(makeUserRow(u, q)));
      } else {
        usersBox.innerHTML = '<div class="hint">Foydalanuvchilar topilmadi.</div>';
      }
    } catch (err) {
      console.error(err);
      gallery.innerHTML = '<div class="hint">Xatolik yuz berdi — server bilan bog‘laning.</div>';
      usersBox.innerHTML = '<div class="hint">Xatolik yuz berdi.</div>';
    }
  }



  function debounce(fn, wait) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); }; }
  const debouncedSearch = debounce(value => doSearch(value), 300);



  input.addEventListener('input', (e) => debouncedSearch(e.target.value));
  input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); doSearch(input.value); } });
  clearBtn.addEventListener('click', () => { input.value = ''; input.focus(); doSearch(''); });









  let recognition;
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRec();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    voiceBtn.addEventListener('click', () => {
      if (voiceBtn.dataset.listening === '1') { recognition.stop(); return; }
      recognition.start();
      voiceBtn.dataset.listening = '1';
      voiceBtn.innerText = 'Listening…';
    });

    recognition.onresult = (ev) => {
      const transcript = ev.results[0][0].transcript || '';
      input.value = transcript;
      doSearch(transcript);
    };
    recognition.onend = () => {
      voiceBtn.dataset.listening = '0';
      voiceBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 11v1a7 7 0 0 1-14 0v-1" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 19v4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    };
    recognition.onerror = (ev) => { console.warn('Speech error', ev); recognition.stop(); };
  } else {
    if (voiceBtn) {
      voiceBtn.style.opacity = 0.6;
      voiceBtn.title = "Voice search not supported";
    }
  }

</script>


{% endblock content %}