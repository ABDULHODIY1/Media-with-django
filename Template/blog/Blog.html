{% extends 'base.html' %}
{% block content %}

<div id="Blog_container">
  {% if posts %}
  {% for post in posts %}
  <div class="blog_card" data-post-id="{{ post.id }}">

    <!-- Author -->
    {% if post.author %}
    <a href="{% url 'app:prof' username=post.author.username %}" id="author_name">
      @{{ post.author.username }}
    </a>
    {% endif %}

    <!-- Media -->
    {% if post.video %}
    <video class="video_size_post" controls>
      <source src="{{ post.video.url }}" type="video/mp4">
    </video>
    {% elif post.image %}
    <img src="{{ post.image.url }}" alt="{{ post.text }}" id="x1sqx">
    {% endif %}

    <p class="Info">{{ post.text }}</p>

    <div class="saved">
      <!-- Like count -->
      <p class="like-count" id="like-count-{{ post.id }}">{{ post.total_likes }}</p>

      <!-- Save count -->
      <p class="save-count" id="save-count-{{ post.id }}">{{ post.total_saves }}</p>

      <!-- Like button -->
      <button class="like-btn" data-post-id="{{ post.id }}" style="background:none; border:none;">
        <svg aria-label="Like" fill="currentColor" height="24" role="img" viewBox="0 0 24 24" width="24">
          <path d="M16.792 3.904..."></path>
        </svg>
      </button>

      <!-- Save button -->
      <button class="save-btn" data-post-id="{{ post.id }}" style="background:none; border:none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 36 36">
          <path d="M33,10H27..."></path>
        </svg>
      </button>
    </div>
  </div>
  {% endfor %}
  {% else %}
  <p>No posts found.</p>
  {% endif %}
</div>


<script>
  // AJAX CSRF
  function getCSRFToken() {
    const name = 'csrftoken';
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      const [key, value] = cookie.trim().split('=');
      if (key === name) return decodeURIComponent(value);
    }
    return '';
  }

  // Like toggle
  document.querySelectorAll('.like-btn').forEach(button => {
    button.addEventListener('click', function () {
      const postId = this.dataset.postId;
      fetch(`/like-toggle/${postId}/`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': getCSRFToken(),
          'Content-Type': 'application/json'
        }
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            document.getElementById(`like-count-${postId}`).textContent = data.total_likes;
          }
        });
    });
  });

  // Save toggle
  document.querySelectorAll('.save-btn').forEach(button => {
    button.addEventListener('click', function () {
      const postId = this.dataset.postId;
      fetch(`/save-toggle/${postId}/`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': getCSRFToken(),
          'Content-Type': 'application/json'
        }
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            document.getElementById(`save-count-${postId}`).textContent = data.total_saves;
          }
        });
    });
  });

  document.querySelectorAll('.like-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const postId = btn.dataset.postId;
      const res = await fetch(`/like-toggle/${postId}/`, { method: 'POST', headers: { 'X-CSRFToken': csrftoken } });
      const data = await res.json();
      if (data.success) btn.textContent = data.is_liked ? 'Unlike' : 'Like';
    });
  });
</script>


{% endblock content %}