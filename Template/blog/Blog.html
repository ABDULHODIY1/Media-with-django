{% extends 'base.html' %}
{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Blogs</title>
</head>

<body>
  <center>
    {% block content %}
    <div id="Blog_container">
      {% for post in posts %}
      <div class="blog_card" data-post-id="{{ post.id }}">
        {% if post.image or post.video and post.author %}
        <a href="{% url 'app:prof' username=post.author.username %}" target="_blank" id="author_name">
          @{{ post.author.username }}
          {% if post.author.username == "thony" %}
          <span style="color:cornflowerblue;">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor"
              class="bi bi-patch-check-fill" viewBox="0 0 16 16">
              <path
                d="M10.067.87a2.89 2.89 0 0 0-4.134 0l-.622.638-.89-.011a2.89 2.89 0 0 0-2.924 2.924l.01.89-.636.622a2.89 2.89 0 0 0 0 4.134l.637.622-.011.89a2.89 2.89 0 0 0 2.924 2.924l.89-.01.622.636a2.89 2.89 0 0 0 4.134 0l.622-.637.89.011a2.89 2.89 0 0 0 2.924-2.924l-.01-.89.636-.622a2.89 2.89 0 0 0 0-4.134l-.637-.622.011-.89a2.89 2.89 0 0 0-2.924-2.924l-.89.01zm.287 5.984-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7 8.793l2.646-2.647a.5.5 0 0 1 .708.708" />
            </svg></span> <!-- kok check belgi -->
          {% endif %}
        </a>
        {% endif %}

        {% if post.image %}
        <img src="{{ post.image.url }}" id="x1sqx" width="100%" height="250">
        {% endif %}

        {% if post.video %}
        <video class="video_size_post" controls>
          <source src="{{ post.video.url }}" type="video/mp4">
          Your browser does not support the video tag.
        </video>
        {% endif %}

        <p class="Info">{{ post.text }}</p>

        <div class="saved">
          <p class="like-count" id="like-count-{{ post.id }}">{{ post.total_likes }}</p>
          <p id="save_count">{{ post.views_typer }}</p>

          <!-- Like button with AJAX -->
          <button class="like-btn" data-post-id="{{ post.id }}" style="background: none; border: none;">
            <svg fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
              <path
                d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0 3.072-2.652 4.959-5.197 7.222-2.512 2.243-3.865 3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141 14.072 2.5 12.167 2.5 9.122a4.989 4.989 0 0 1 4.708-5.218 4.21 4.21 0 0 1 3.675 1.941c.84 1.175.98 1.763 1.12 1.763s.278-.588 1.11-1.766a4.17 4.17 0 0 1 3.679-1.938z" />
            </svg>
          </button>

          <!-- Save icon -->
          <svg xmlns="http://www.w3.org/2000/svg" id="icon_save" width="28" height="28" viewBox="0 0 36 36">
            <path
              d="M33,10H27a1,1,0,0,0-1,1v2a1,1,0,0,0,1,1h3V30H6V14H9a1,1,0,0,0,1-1V11a1,1,0,0,0-1-1H3a1,1,0,0,0-1,1V33a1,1,0,0,0,1,1H33a1,1,0,0,0,1-1V11A1,1,0,0,0,33,10Z" />
            <path
              d="M10.2,17.33l7.45,7.53a0.5,0.5,0,0,0,.7,0l7.45-7.53A0.79,0.79,0,0,0,26,16.8a0.8,0.8,0,0,0-.8-0.8H20V3a1,1,0,0,0-1-1H17a1,1,0,0,0-1,1V16H10.8A0.8,0.8,0,0,0,10,16.8,0.79,0.79,0,0,0,10.2,17.33Z" />
          </svg>
        </div>
      </div>
      {% empty %}
      <p>No posts found.</p>
      {% endfor %}
    </div>

    <!-- AJAX Script -->
    <script>
      document.querySelectorAll('.like-btn').forEach(button => {
        button.addEventListener('click', function () {
          const postId = this.dataset.postId;
          fetch(`/like-toggle/${postId}/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCSRFToken(),
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                const countElem = document.getElementById(`like-count-${postId}`);
                countElem.textContent = data.total_likes;
              } else {
                alert(data.message);
              }
            });
        });
      });

      // CSRF helper
      function getCSRFToken() {
        const name = 'csrftoken';
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          const [key, value] = cookie.trim().split('=');
          if (key === name) return decodeURIComponent(value);
        }
        return '';
      }
    </script>
    {% endblock content %}

  </center>
</body>

</html>